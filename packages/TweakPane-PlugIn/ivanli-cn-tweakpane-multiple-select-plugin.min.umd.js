!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).IvanliCnTweakpaneMultipleSelectPlugin={})}(this,(function(e){"use strict";class t{constructor(){this.observers_={}}on(e,t){let i=this.observers_[e];return i||(i=this.observers_[e]=[]),i.push({handler:t}),this}off(e,t){const i=this.observers_[e];return i&&(this.observers_[e]=i.filter((e=>e.handler!==t))),this}emit(e,t){const i=this.observers_[e];i&&i.forEach((e=>{e.handler(t)}))}}const i="tp";class s{constructor(e,i){var s;this.constraint_=null==i?void 0:i.constraint,this.equals_=null!==(s=null==i?void 0:i.equals)&&void 0!==s?s:(e,t)=>e===t,this.emitter=new t,this.rawValue_=e}get constraint(){return this.constraint_}get rawValue(){return this.rawValue_}set rawValue(e){this.setRawValue(e,{forceEmit:!1,last:!0})}setRawValue(e,t){const i=null!=t?t:{forceEmit:!1,last:!0},s=this.constraint_?this.constraint_.constrain(e):e,n=this.rawValue_;(!this.equals_(n,s)||i.forceEmit)&&(this.emitter.emit("beforechange",{sender:this}),this.rawValue_=s,this.emitter.emit("change",{options:i,previousRawValue:n,rawValue:s,sender:this}))}}class n{constructor(e){this.emitter=new t,this.value_=e}get rawValue(){return this.value_}set rawValue(e){this.setRawValue(e,{forceEmit:!1,last:!0})}setRawValue(e,t){const i=null!=t?t:{forceEmit:!1,last:!0},s=this.value_;(s!==e||i.forceEmit)&&(this.emitter.emit("beforechange",{sender:this}),this.value_=e,this.emitter.emit("change",{options:i,previousRawValue:s,rawValue:this.value_,sender:this}))}}function o(e,t){const i=null==t?void 0:t.constraint,o=null==t?void 0:t.equals;return i||o?new s(e,t):new n(e)}class r{constructor(e){this.emitter=new t,this.valMap_=e;for(const e in this.valMap_){this.valMap_[e].emitter.on("change",(()=>{this.emitter.emit("change",{key:e,sender:this})}))}}static createCore(e){return Object.keys(e).reduce(((t,i)=>Object.assign(t,{[i]:o(e[i])})),{})}static fromObject(e){const t=this.createCore(e);return new r(t)}get(e){return this.valMap_[e].rawValue}set(e,t){this.valMap_[e].rawValue=t}value(e){return this.valMap_[e]}}function l(e){return t=>i=>{if(!t&&void 0===i)return{succeeded:!1,value:void 0};if(t&&void 0===i)return{succeeded:!0,value:void 0};const s=e(i);return void 0!==s?{succeeded:!0,value:s}:{succeeded:!1,value:void 0}}}function a(e){return{custom:t=>l(t)(e),boolean:l((e=>"boolean"==typeof e?e:void 0))(e),number:l((e=>"number"==typeof e?e:void 0))(e),string:l((e=>"string"==typeof e?e:void 0))(e),function:l((e=>"function"==typeof e?e:void 0))(e),constant:t=>l((e=>e===t?t:void 0))(e),raw:l((e=>e))(e),object:t=>l((e=>{var i;if(null!==(i=e)&&"object"==typeof i)return function(e,t){return Object.keys(t).reduce(((i,s)=>{if(void 0===i)return;const n=(0,t[s])(e[s]);return n.succeeded?Object.assign(Object.assign({},i),{[s]:n.value}):void 0}),{})}(e,t)}))(e),array:t=>l((e=>{var i;if(Array.isArray(e))return i=t,e.reduce(((e,t)=>{if(void 0===e)return;const s=i(t);return s.succeeded&&void 0!==s.value?[...e,s.value]:void 0}),[])}))(e)}}const u={optional:a(!0),required:a(!1)};class c{constructor(e){this.values=r.fromObject({options:e})}get options(){return this.values.get("options")}constrain(e){const t=this.values.get("options");if(0===t.length)return e;return t.filter((t=>t.value===e)).length>0?e:t[0].value}}function h(e,t){var i,s;const n=t.ownerDocument.defaultView,o=t.getBoundingClientRect();return{x:e.pageX-((null!==(i=n&&n.scrollX)&&void 0!==i?i:0)+o.left),y:e.pageY-((null!==(s=n&&n.scrollY)&&void 0!==s?s:0)+o.top)}}class d{constructor(e){this.lastTouch_=null,this.onDocumentMouseMove_=this.onDocumentMouseMove_.bind(this),this.onDocumentMouseUp_=this.onDocumentMouseUp_.bind(this),this.onMouseDown_=this.onMouseDown_.bind(this),this.onTouchEnd_=this.onTouchEnd_.bind(this),this.onTouchMove_=this.onTouchMove_.bind(this),this.onTouchStart_=this.onTouchStart_.bind(this),this.elem_=e,this.emitter=new t,e.addEventListener("touchstart",this.onTouchStart_,{passive:!1}),e.addEventListener("touchmove",this.onTouchMove_,{passive:!0}),e.addEventListener("touchend",this.onTouchEnd_),e.addEventListener("mousedown",this.onMouseDown_)}computePosition_(e){const t=this.elem_.getBoundingClientRect();return{bounds:{width:t.width,height:t.height},point:e?{x:e.x,y:e.y}:null}}onMouseDown_(e){var t;e.preventDefault(),null===(t=e.currentTarget)||void 0===t||t.focus();const i=this.elem_.ownerDocument;i.addEventListener("mousemove",this.onDocumentMouseMove_),i.addEventListener("mouseup",this.onDocumentMouseUp_),this.emitter.emit("down",{altKey:e.altKey,data:this.computePosition_(h(e,this.elem_)),sender:this,shiftKey:e.shiftKey})}onDocumentMouseMove_(e){this.emitter.emit("move",{altKey:e.altKey,data:this.computePosition_(h(e,this.elem_)),sender:this,shiftKey:e.shiftKey})}onDocumentMouseUp_(e){const t=this.elem_.ownerDocument;t.removeEventListener("mousemove",this.onDocumentMouseMove_),t.removeEventListener("mouseup",this.onDocumentMouseUp_),this.emitter.emit("up",{altKey:e.altKey,data:this.computePosition_(h(e,this.elem_)),sender:this,shiftKey:e.shiftKey})}onTouchStart_(e){e.preventDefault();const t=e.targetTouches.item(0),i=this.elem_.getBoundingClientRect();this.emitter.emit("down",{altKey:e.altKey,data:this.computePosition_(t?{x:t.clientX-i.left,y:t.clientY-i.top}:void 0),sender:this,shiftKey:e.shiftKey}),this.lastTouch_=t}onTouchMove_(e){const t=e.targetTouches.item(0),i=this.elem_.getBoundingClientRect();this.emitter.emit("move",{altKey:e.altKey,data:this.computePosition_(t?{x:t.clientX-i.left,y:t.clientY-i.top}:void 0),sender:this,shiftKey:e.shiftKey}),this.lastTouch_=t}onTouchEnd_(e){var t;const i=null!==(t=e.targetTouches.item(0))&&void 0!==t?t:this.lastTouch_,s=this.elem_.getBoundingClientRect();this.emitter.emit("up",{altKey:e.altKey,data:this.computePosition_(i?{x:i.clientX-s.left,y:i.clientY-s.top}:void 0),sender:this,shiftKey:e.shiftKey})}}function v(e){const t=u;return Array.isArray(e)?t.required.array(t.required.object({text:t.required.string,value:t.required.raw}))(e).value:"object"==typeof e?t.required.raw(e).value:void 0}const p=(m="multiple-select",(e,t)=>[i,"-",m,"v",e?`_${e}`:"",t?`-${t}`:""].join(""));var m;class _{constructor(e,t){this.optionEls=[],this.emptyEl=null,this.element=e.createElement("div"),this.element.classList.add(p()),t.viewProps.bindClassModifiers(this.element),this.value_=t.value,this.value_.emitter.on("change",this.onValueChange_.bind(this)),this.lc=t.lc,this.containerEl=e.createElement("div"),this.containerEl.classList.add(p("container")),this.element.appendChild(this.containerEl),this.refresh_(),t.viewProps.handleDispose((()=>{console.log("TODO: dispose view")}))}refresh_(){const e=this.value_.rawValue;for(;this.optionEls.length>0;){const e=this.optionEls.shift();e&&this.containerEl.removeChild(e)}const t=this.element.ownerDocument;0!==this.lc.values.get("options").length||this.emptyEl?this.emptyEl&&(this.containerEl.removeChild(this.emptyEl),this.emptyEl=null):(this.emptyEl=t.createElement("div"),this.emptyEl.classList.add(p("empty")),this.emptyEl.textContent="(empty)",this.containerEl.appendChild(this.emptyEl)),this.lc.values.get("options").forEach((i=>{const s=t.createElement("label");s.classList.add(p("option"));const n=t.createElement("input");n.classList.add(p("input")),n.type="checkbox",n.checked=e.includes(i.value),n.addEventListener("input",(()=>{let e=this.value_.rawValue;e=n.checked?[...e,i.value]:e.filter((e=>e!==i.value)),this.value_.setRawValue(e)})),s.appendChild(n);const o=t.createElement("span");o.classList.add(p("text")),o.textContent=i.text,s.appendChild(o),this.optionEls.push(s),this.containerEl.appendChild(s)}))}onValueChange_(){this.refresh_()}}class f{constructor(e,t){this.onPoint_=this.onPoint_.bind(this),this.value=t.value;const i=new c(function(e){if(Array.isArray(e))return e;const t=[];return Object.keys(e).forEach((i=>{t.push({text:i,value:e[i]})})),t}(t.options));this.lc=i,this.viewProps=t.viewProps,this.viewProps.handleDispose((()=>{console.log("TODO: dispose controller")})),this.view=new _(e,{value:this.value,viewProps:this.viewProps,lc:this.lc});const s=new d(this.view.element);s.emitter.on("down",this.onPoint_),s.emitter.on("move",this.onPoint_),s.emitter.on("up",this.onPoint_)}onPoint_(){}}const y=[{id:"input-multiple-select",type:"input",css:".tp-multiple-selectv{max-height:calc(var(--bld-us)*5);overflow-y:auto;position:relative;color:var(--in-fg)}.tp-multiple-selectv.tp-v-disabled{opacity:.5}.tp-multiple-selectv_option{display:flex;align-content:center;gap:5px;margin-top:2px;margin-bottom:2px}.tp-multiple-selectv_input{margin:0}.tp-multiple-selectv_text{flex:auto}.tp-multiple-selectv_empty{color:var(--in-fg-placeholder)}",accept(e,t){if(null!=e&&!Array.isArray(e))return null;const i=u,s=function(e,t){const i=u.required.object(t)(e);return i.succeeded?i.value:void 0}(t,{view:i.required.constant("multiple-select"),options:i.required.custom(v)});return s?{initialValue:e,params:s}:null},binding:{reader:e=>e=>Array.isArray(e)?e:[],writer:e=>(e,t)=>{e.write(t)}},controller:e=>new f(e.document,{value:e.value,viewProps:e.viewProps,options:e.params.options})}];e.plugins=y,Object.defineProperty(e,"__esModule",{value:!0})}));
