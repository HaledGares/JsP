!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TweakpaneAudioPlayerPlugin={})}(this,(function(e){"use strict";class t{constructor(e){this.controller_=e}get element(){return this.controller_.view.element}get disabled(){return this.controller_.viewProps.get("disabled")}set disabled(e){this.controller_.viewProps.set("disabled",e)}get hidden(){return this.controller_.viewProps.get("hidden")}set hidden(e){this.controller_.viewProps.set("hidden",e)}dispose(){this.controller_.viewProps.set("disposed",!0)}}class i{constructor(){this.observers_={}}on(e,t){let i=this.observers_[e];return i||(i=this.observers_[e]=[]),i.push({handler:t}),this}off(e,t){const i=this.observers_[e];return i&&(this.observers_[e]=i.filter((e=>e.handler!==t))),this}emit(e,t){const i=this.observers_[e];i&&i.forEach((e=>{e.handler(t)}))}}const s="tp";function n(e){return(t,i)=>[s,"-",e,"v",t?`_${t}`:"",i?`-${i}`:""].join("")}function o(e){return e.rawValue}function a(e,t){var i,s;e.emitter.on("change",(i=o,s=t,e=>s(i(e)))),t(e.rawValue)}function r(e,t,i){a(e.value(t),i)}class l{constructor(e,t){var s;this.constraint_=null==t?void 0:t.constraint,this.equals_=null!==(s=null==t?void 0:t.equals)&&void 0!==s?s:(e,t)=>e===t,this.emitter=new i,this.rawValue_=e}get constraint(){return this.constraint_}get rawValue(){return this.rawValue_}set rawValue(e){this.setRawValue(e,{forceEmit:!1,last:!0})}setRawValue(e,t){const i=null!=t?t:{forceEmit:!1,last:!0},s=this.constraint_?this.constraint_.constrain(e):e,n=this.rawValue_;(!this.equals_(n,s)||i.forceEmit)&&(this.emitter.emit("beforechange",{sender:this}),this.rawValue_=s,this.emitter.emit("change",{options:i,previousRawValue:n,rawValue:s,sender:this}))}}class d{constructor(e){this.emitter=new i,this.value_=e}get rawValue(){return this.value_}set rawValue(e){this.setRawValue(e,{forceEmit:!1,last:!0})}setRawValue(e,t){const i=null!=t?t:{forceEmit:!1,last:!0},s=this.value_;(s!==e||i.forceEmit)&&(this.emitter.emit("beforechange",{sender:this}),this.value_=e,this.emitter.emit("change",{options:i,previousRawValue:s,rawValue:this.value_,sender:this}))}}function h(e,t){const i=null==t?void 0:t.constraint,s=null==t?void 0:t.equals;return i||s?new l(e,t):new d(e)}class u{constructor(e){this.emitter=new i,this.valMap_=e;for(const e in this.valMap_){this.valMap_[e].emitter.on("change",(()=>{this.emitter.emit("change",{key:e,sender:this})}))}}static createCore(e){return Object.keys(e).reduce(((t,i)=>Object.assign(t,{[i]:h(e[i])})),{})}static fromObject(e){const t=this.createCore(e);return new u(t)}get(e){return this.valMap_[e].rawValue}set(e,t){this.valMap_[e].rawValue=t}value(e){return this.valMap_[e]}}function c(e){return t=>i=>{if(!t&&void 0===i)return{succeeded:!1,value:void 0};if(t&&void 0===i)return{succeeded:!0,value:void 0};const s=e(i);return void 0!==s?{succeeded:!0,value:s}:{succeeded:!1,value:void 0}}}function p(e){return{custom:t=>c(t)(e),boolean:c((e=>"boolean"==typeof e?e:void 0))(e),number:c((e=>"number"==typeof e?e:void 0))(e),string:c((e=>"string"==typeof e?e:void 0))(e),function:c((e=>"function"==typeof e?e:void 0))(e),constant:t=>c((e=>e===t?t:void 0))(e),raw:c((e=>e))(e),object:t=>c((e=>{var i;if(null!==(i=e)&&"object"==typeof i)return function(e,t){return Object.keys(t).reduce(((i,s)=>{if(void 0===i)return;const n=(0,t[s])(e[s]);return n.succeeded?Object.assign(Object.assign({},i),{[s]:n.value}):void 0}),{})}(e,t)}))(e),array:t=>c((e=>{var i;if(Array.isArray(e))return i=t,e.reduce(((e,t)=>{if(void 0===e)return;const s=i(t);return s.succeeded&&void 0!==s.value?[...e,s.value]:void 0}),[])}))(e)}}const v={optional:p(!0),required:p(!1)};class m{constructor(e){this.value_=e}static create(e){return[new m(e),(t,i)=>{e.setRawValue(t,i)}]}get emitter(){return this.value_.emitter}get rawValue(){return this.value_.rawValue}}const b=n("");function _(e,t){return function(e,t){return i=>{!function(e,t,i){i?e.classList.add(t):e.classList.remove(t)}(e,t,i)}}(e,b(void 0,t))}class f extends u{constructor(e){var t;super(e),this.onDisabledChange_=this.onDisabledChange_.bind(this),this.onParentChange_=this.onParentChange_.bind(this),this.onParentGlobalDisabledChange_=this.onParentGlobalDisabledChange_.bind(this),[this.globalDisabled_,this.setGlobalDisabled_]=m.create(h(this.getGlobalDisabled_())),this.value("disabled").emitter.on("change",this.onDisabledChange_),this.value("parent").emitter.on("change",this.onParentChange_),null===(t=this.get("parent"))||void 0===t||t.globalDisabled.emitter.on("change",this.onParentGlobalDisabledChange_)}static create(e){var t,i,s;const n=null!=e?e:{};return new f(u.createCore({disabled:null!==(t=n.disabled)&&void 0!==t&&t,disposed:!1,hidden:null!==(i=n.hidden)&&void 0!==i&&i,parent:null!==(s=n.parent)&&void 0!==s?s:null}))}get globalDisabled(){return this.globalDisabled_}bindClassModifiers(e){a(this.globalDisabled_,_(e,"disabled")),r(this,"hidden",_(e,"hidden"))}bindDisabled(e){a(this.globalDisabled_,(t=>{e.disabled=t}))}bindTabIndex(e){a(this.globalDisabled_,(t=>{e.tabIndex=t?-1:0}))}handleDispose(e){this.value("disposed").emitter.on("change",(t=>{t&&e()}))}getGlobalDisabled_(){const e=this.get("parent");return!!e&&e.globalDisabled.rawValue||this.get("disabled")}updateGlobalDisabled_(){this.setGlobalDisabled_(this.getGlobalDisabled_())}onDisabledChange_(){this.updateGlobalDisabled_()}onParentGlobalDisabledChange_(){this.updateGlobalDisabled_()}onParentChange_(e){var t;const i=e.previousRawValue;null==i||i.globalDisabled.emitter.off("change",this.onParentGlobalDisabledChange_),null===(t=this.get("parent"))||void 0===t||t.globalDisabled.emitter.on("change",this.onParentGlobalDisabledChange_),this.updateGlobalDisabled_()}}const g=n(""),w={veryfirst:"vfst",first:"fst",last:"lst",verylast:"vlst"};class y{constructor(e){this.parent_=null,this.blade=e.blade,this.view=e.view,this.viewProps=e.viewProps;const t=this.view.element;this.blade.value("positions").emitter.on("change",(()=>{["veryfirst","first","last","verylast"].forEach((e=>{t.classList.remove(g(void 0,w[e]))})),this.blade.get("positions").forEach((e=>{t.classList.add(g(void 0,w[e]))}))})),this.viewProps.handleDispose((()=>{!function(e){e&&e.parentElement&&e.parentElement.removeChild(e)}(t)}))}get parent(){return this.parent_}set parent(e){if(this.parent_=e,!("parent"in this.viewProps.valMap_))return t={key:"parent",target:f.name,place:"BladeController.parent"},void console.warn([`Missing '${t.key}' of ${t.target} in ${t.place}.`,"Please rebuild plugins with the latest core package."].join(" "));var t;this.viewProps.set("parent",this.parent_?this.parent_.viewProps:null)}}const P=n("lbl");class E{constructor(e,t){this.element=e.createElement("div"),this.element.classList.add(P()),t.viewProps.bindClassModifiers(this.element);const i=e.createElement("div");i.classList.add(P("l")),r(t.props,"label",(t=>{!function(e){return null==e}(t)?(this.element.classList.remove(P(void 0,"nol")),function(e){for(;e.childNodes.length>0;)e.removeChild(e.childNodes[0])}(i),i.appendChild(function(e,t){const i=e.createDocumentFragment();return t.split("\n").map((t=>e.createTextNode(t))).forEach(((t,s)=>{s>0&&i.appendChild(e.createElement("br")),i.appendChild(t)})),i}(e,t))):this.element.classList.add(P(void 0,"nol"))})),this.element.appendChild(i),this.labelElement=i;const s=e.createElement("div");s.classList.add(P("v")),this.element.appendChild(s),this.valueElement=s}}class C extends y{constructor(e,t){const i=t.valueController.viewProps;super(Object.assign(Object.assign({},t),{view:new E(e,{props:t.props,viewProps:i}),viewProps:i})),this.props=t.props,this.valueController=t.valueController,this.view.valueElement.appendChild(this.valueController.view.element)}}class D{constructor(e){this.values=u.fromObject({max:e.max,min:e.min})}constrain(e){const t=this.values.get("max"),i=this.values.get("min");return Math.min(Math.max(e,i),t)}}function x(e){return t=>t.toFixed(Math.max(Math.min(e,20),0))}x(0);function M(e,t){const i=e*(t.altKey?.1:1)*(t.shiftKey?10:1);return t.upKey?+i:t.downKey?-i:0}function V(e){return{altKey:e.altKey,downKey:"ArrowLeft"===e.key,shiftKey:e.shiftKey,upKey:"ArrowRight"===e.key}}function L(e,t){var i,s;const n=t.ownerDocument.defaultView,o=t.getBoundingClientRect();return{x:e.pageX-((null!==(i=n&&n.scrollX)&&void 0!==i?i:0)+o.left),y:e.pageY-((null!==(s=n&&n.scrollY)&&void 0!==s?s:0)+o.top)}}class K{constructor(e){this.lastTouch_=null,this.onDocumentMouseMove_=this.onDocumentMouseMove_.bind(this),this.onDocumentMouseUp_=this.onDocumentMouseUp_.bind(this),this.onMouseDown_=this.onMouseDown_.bind(this),this.onTouchEnd_=this.onTouchEnd_.bind(this),this.onTouchMove_=this.onTouchMove_.bind(this),this.onTouchStart_=this.onTouchStart_.bind(this),this.elem_=e,this.emitter=new i,e.addEventListener("touchstart",this.onTouchStart_,{passive:!1}),e.addEventListener("touchmove",this.onTouchMove_,{passive:!0}),e.addEventListener("touchend",this.onTouchEnd_),e.addEventListener("mousedown",this.onMouseDown_)}computePosition_(e){const t=this.elem_.getBoundingClientRect();return{bounds:{width:t.width,height:t.height},point:e?{x:e.x,y:e.y}:null}}onMouseDown_(e){var t;e.preventDefault(),null===(t=e.currentTarget)||void 0===t||t.focus();const i=this.elem_.ownerDocument;i.addEventListener("mousemove",this.onDocumentMouseMove_),i.addEventListener("mouseup",this.onDocumentMouseUp_),this.emitter.emit("down",{altKey:e.altKey,data:this.computePosition_(L(e,this.elem_)),sender:this,shiftKey:e.shiftKey})}onDocumentMouseMove_(e){this.emitter.emit("move",{altKey:e.altKey,data:this.computePosition_(L(e,this.elem_)),sender:this,shiftKey:e.shiftKey})}onDocumentMouseUp_(e){const t=this.elem_.ownerDocument;t.removeEventListener("mousemove",this.onDocumentMouseMove_),t.removeEventListener("mouseup",this.onDocumentMouseUp_),this.emitter.emit("up",{altKey:e.altKey,data:this.computePosition_(L(e,this.elem_)),sender:this,shiftKey:e.shiftKey})}onTouchStart_(e){e.preventDefault();const t=e.targetTouches.item(0),i=this.elem_.getBoundingClientRect();this.emitter.emit("down",{altKey:e.altKey,data:this.computePosition_(t?{x:t.clientX-i.left,y:t.clientY-i.top}:void 0),sender:this,shiftKey:e.shiftKey}),this.lastTouch_=t}onTouchMove_(e){const t=e.targetTouches.item(0),i=this.elem_.getBoundingClientRect();this.emitter.emit("move",{altKey:e.altKey,data:this.computePosition_(t?{x:t.clientX-i.left,y:t.clientY-i.top}:void 0),sender:this,shiftKey:e.shiftKey}),this.lastTouch_=t}onTouchEnd_(e){var t;const i=null!==(t=e.targetTouches.item(0))&&void 0!==t?t:this.lastTouch_,s=this.elem_.getBoundingClientRect();this.emitter.emit("up",{altKey:e.altKey,data:this.computePosition_(i?{x:i.clientX-s.left,y:i.clientY-s.top}:void 0),sender:this,shiftKey:e.shiftKey})}}function T(e,t,i,s,n){return s+(e-t)/(i-t)*(n-s)}function j(e,t,i){return Math.min(Math.max(e,t),i)}const k=n("sld");class R{constructor(e,t){this.onChange_=this.onChange_.bind(this),this.props_=t.props,this.props_.emitter.on("change",this.onChange_),this.element=e.createElement("div"),this.element.classList.add(k()),t.viewProps.bindClassModifiers(this.element);const i=e.createElement("div");i.classList.add(k("t")),t.viewProps.bindTabIndex(i),this.element.appendChild(i),this.trackElement=i;const s=e.createElement("div");s.classList.add(k("k")),this.trackElement.appendChild(s),this.knobElement=s,t.value.emitter.on("change",this.onChange_),this.value=t.value,this.update_()}update_(){const e=j(T(this.value.rawValue,this.props_.get("minValue"),this.props_.get("maxValue"),0,100),0,100);this.knobElement.style.width=`${e}%`}onChange_(){this.update_()}}class O{constructor(e,t){this.onKeyDown_=this.onKeyDown_.bind(this),this.onKeyUp_=this.onKeyUp_.bind(this),this.onPointerDownOrMove_=this.onPointerDownOrMove_.bind(this),this.onPointerUp_=this.onPointerUp_.bind(this),this.baseStep_=t.baseStep,this.value=t.value,this.viewProps=t.viewProps,this.props=t.props,this.view=new R(e,{props:this.props,value:this.value,viewProps:this.viewProps}),this.ptHandler_=new K(this.view.trackElement),this.ptHandler_.emitter.on("down",this.onPointerDownOrMove_),this.ptHandler_.emitter.on("move",this.onPointerDownOrMove_),this.ptHandler_.emitter.on("up",this.onPointerUp_),this.view.trackElement.addEventListener("keydown",this.onKeyDown_),this.view.trackElement.addEventListener("keyup",this.onKeyUp_)}handlePointerEvent_(e,t){e.point&&this.value.setRawValue(T(j(e.point.x,0,e.bounds.width),0,e.bounds.width,this.props.get("minValue"),this.props.get("maxValue")),t)}onPointerDownOrMove_(e){this.handlePointerEvent_(e.data,{forceEmit:!1,last:!1})}onPointerUp_(e){this.handlePointerEvent_(e.data,{forceEmit:!0,last:!0})}onKeyDown_(e){const t=M(this.baseStep_,V(e));0!==t&&this.value.setRawValue(this.value.rawValue+t,{forceEmit:!1,last:!1})}onKeyUp_(e){0!==M(this.baseStep_,V(e))&&this.value.setRawValue(this.value.rawValue,{forceEmit:!0,last:!0})}}function S(e){return[e[0],e[1],e[2]]}function $(e){return t=>function(e,t){const i=x("float"===t?2:0);return`rgb(${S(e.getComponents("rgb",t)).map((e=>i(e))).join(", ")})`}(t,e)}function G(e){return t=>function(e,t){const i=x(2),s=x("float"===t?2:0);return`rgba(${e.getComponents("rgb",t).map(((e,t)=>(3===t?i:s)(e))).join(", ")})`}(t,e)}function U(e){return t=>function(e,t){const i=x("float"===t?2:0),s=["r","g","b"];return`{${S(e.getComponents("rgb",t)).map(((e,t)=>`${s[t]}: ${i(e)}`)).join(", ")}}`}(t,e)}function q(e){return t=>function(e,t){const i=x(2),s=x("float"===t?2:0),n=["r","g","b","a"];return`{${e.getComponents("rgb",t).map(((e,t)=>`${n[t]}: ${(3===t?i:s)(e)}`)).join(", ")}}`}(t,e)}["int","float"].reduce(((e,t)=>[...e,{format:{alpha:!1,mode:"rgb",notation:"func",type:t},stringifier:$(t)},{format:{alpha:!0,mode:"rgb",notation:"func",type:t},stringifier:G(t)},{format:{alpha:!1,mode:"rgb",notation:"object",type:t},stringifier:U(t)},{format:{alpha:!0,mode:"rgb",notation:"object",type:t},stringifier:q(t)}]),[]);class B extends t{get label(){return this.controller_.props.get("label")}set label(e){this.controller_.props.set("label",e)}get audio(){return this.controller_.valueController.audio}get source(){return this.controller_.valueController.props.get("source")}set source(e){this.controller_.valueController.props.set("source",e),this.audio.src=e}}function A(e,t,i,s){return new(i||(i=Promise))((function(n,o){function a(e){try{l(s.next(e))}catch(e){o(e)}}function r(e){try{l(s.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,r)}l((s=s.apply(e,t||[])).next())}))}const X=n("plyr");class Y{constructor(e,t){this.element=e.createElement("div"),this.element.classList.add(X()),t.viewProps.bindClassModifiers(this.element);const i=e.createElement("div");i.classList.add(X("w")),this.element.appendChild(i);const s=e.createElement("div");s.classList.add(X("wb")),i.appendChild(s),this.wrapBtn=s;const n=e.createElement("div");n.classList.add(X("wt")),this.element.appendChild(n);const o=e.createElement("div");o.classList.add(X("b")),o.classList.add("play"),s.appendChild(o),this.btn=o;const a=e.createElement("div");a.classList.add(X("s")),this.sliderView_=t.sliderView,a.appendChild(this.sliderView_.element),i.appendChild(a);const r=e.createElement("div");r.classList.add(X("t")),r.innerText="00:00",n.appendChild(r),this.elapsed=r,this.audio=t.audio,this.wrapBtn.addEventListener("click",this.onPlayPause_.bind(this)),this.audio.addEventListener("loadedmetadata",this.onLoadedMetadata.bind(this)),this.audio.addEventListener("timeupdate",this.onTimeUpdate_.bind(this)),this.audio.addEventListener("ended",this.onEnded_.bind(this)),this.audio.addEventListener("play",this.onPlay_.bind(this)),this.audio.addEventListener("pause",this.onPause_.bind(this)),this.sliderView_.value.emitter.on("change",this.onSliderChange_.bind(this))}formatTime_(e){const t=~~(e%60);return`${String(~~(e/60)).padStart(2,"0")}:${String(t).padStart(2,"0")}`}onPlayPause_(){return A(this,void 0,void 0,(function*(){this.audio.paused?yield this.audio.play():this.audio.pause()}))}onSliderChange_(e){if(!(!e.options.forceEmit&&!e.options.last))return;const t=e.rawValue/100;this.audio.currentTime=this.audio.duration*t}onPlay_(){this.btn.classList.add("pause")}onPause_(){this.btn.classList.remove("pause")}onLoadedMetadata(){this.audio.currentTime=0,this.btn.classList.remove("pause")}onTimeUpdate_(){const e=this.audio.currentTime/this.audio.duration;this.sliderView_.value.setRawValue(100*e),this.elapsed.innerText=this.formatTime_(this.audio.currentTime)}onEnded_(){this.btn.classList.remove("pause")}}class H{constructor(e,t){this.props=t.props,this.viewProps=t.viewProps,this.value=t.value,this.audio=e.createElement("audio"),this.audio.src=t.props.value("source").rawValue,this.sliderC_=new O(e,{baseStep:t.baseStep,props:t.sliderProps,value:t.value,viewProps:this.viewProps}),this.view=new Y(e,{sliderView:this.sliderC_.view,props:this.props,viewProps:this.viewProps,audio:this.audio})}}const I=[{id:"blade-audio-player",type:"blade",css:".tp-plyrv{display:flex}.tp-plyrv_w{flex:2;display:flex}.tp-plyrv_wb{flex:1;display:flex;align-items:center;margin-left:6px}.tp-plyrv_wt{flex:1;margin-left:4px}.tp-plyrv_b.play{width:12px;height:12px;box-sizing:border-box;border-style:solid;border-width:6px 0px 6px 12px;border-color:rgba(0,0,0,0) rgba(0,0,0,0) rgba(0,0,0,0) var(--in-fg)}.tp-plyrv_b.pause{border-style:double;border-width:0px 0px 0px 10px}.tp-plyrv_s{flex:3}.tp-plyrv_s .tp-sldv_k::after{display:none}.tp-plyrv_s .tp-sldv_t{margin:0}.tp-plyrv_t{box-sizing:border-box;color:var(--lbl-fg);font-family:inherit;height:var(--bld-us);line-height:var(--bld-us);min-width:0;padding:0 4px;text-align:right}",accept(e){const t=v,i=function(e,t){const i=v.required.object(t)(e);return i.succeeded?i.value:void 0}(e,{view:t.required.constant("audio-player"),source:t.required.string,label:t.optional.string});return i?{params:i}:null},controller(e){const t=new D({max:100,min:0}),i=new H(e.document,{baseStep:1,sliderProps:new u({maxValue:t.values.value("max"),minValue:t.values.value("min")}),value:h(0,{constraint:t}),props:u.fromObject({source:e.params.source}),viewProps:e.viewProps});return new C(e.document,{blade:e.blade,props:u.fromObject({label:e.params.label}),valueController:i})},api:e=>e.controller instanceof C&&e.controller.valueController instanceof H?new B(e.controller):null}];e.plugins=I,Object.defineProperty(e,"__esModule",{value:!0})}));
